version: 2

models:
  - name: dim_cloud_jobs
    description: >
      Jobs defined in dbt Cloud, their properties, and summary aggregations of
      their execution steps
    columns:
      - name: job_definition_id
        tests:
          - unique
          - not_null
      - name: count_resource_types
        description: >
          Among the five executable resource types (models, tests, sources,
          snapshots, and seeds), how many does this job "execute"? (Exposures and
          analyses are not themselves executable.)
      - name: dbt_version_run
        description: >
          Some job definitions don't have a dbt version set because the version is set at the environment level.
          This column shows which version of dbt the job will run.
      - name: is_supported_version
        description: >
          Checks to see if this job runs a supported version of dbt Core
      - name: is_latest_major
        description: >
          This column indicates if the run version is on the latest major release of dbt count_resource_types
      - name: is_latest_minor
        description: >
          This column indicates if the run version is on the latest minor release relative to its major version
      - name: is_latest_patch
        description: >
          This column indicates if the run version is on the latest patch relative to its major/minor version

  - name: dim_cloud_outbound_webhooks
    description: >
      Webhooks configured in dbt Cloud, their triggered events, and status codes
      associated with their delivery. Each row is a triggered webhook event.
    columns:
      - name: unique_id
        tests:
          - unique
          - not_null
        description: >
          Deployment agnostic unique identifier across account,
          deployment-specific webhook event_id, and dispatched_at timestamp.
      - name: database_schema
        description: >
          The schema in our data warehouse (typically fivetran connector) used to 
      - name: database_source
        description: >
          Interpretation of database_schema to reflect whether the record is sourced from 'cloud' (US),
          'cloud_emea' (Europe, Middle East, Africa), or 'cloud_au' (Austrailia) deployments.
      - name: database_type
        description: >
          Multi-tenant or single-tenant.
      - name: event_id
        tests:
          - not_null
        description: >
          Deployment-specific ids for webhook events, provided from source.
      - name: account_id
        tests:
          - not_null
        description: >
          Deployment agnostic cloud account ids.
      - name: tenant_account_id
        description: >
          Deployment-specific cloud account ids.
      - name: subscription_id
        description: >
          A webhook id - a subscription configured by the client to listen to events from dbt Cloud.
      - name: subscription_name
        description: >
          The name of the webhook configuration, configured by the client application.
      - name: client_url
        description: >
          The url of the client application listening to dbt Cloud events.
      - name: client_urlhost
        description: >
          The hostname of the client url.
      - name: client_urlpath
        description: >
          The specific path of the client url.
      - name: dbt_version
        description: >
          Parsed from the event payload, dbt version of cloud environment.
      - name: project_id
        description: >
          Parsed from the event payload, project_id of the cloud account.
      - name: project_name
        description: >
          Parsed from the event payload, name of the project dispatching the event.
      - name: environment_id
        description: >
          Parsed from the event payload, environment_id of the cloud account.
      - name: environment_name
        description: >
          Parsed from the event payload, name of the environment dispatching the event.
      - name: job_id
        description: >
          Parsed from the event payload, name of the environment dispatching the event.
      - name: job_name
        description: >
          Parsed from the event payload, the name of the job.
      - name: job_run_id
        description: >
          Parsed from the event payload, job run id associated with this run instance of the job run.
      - name: job_run_reason by the job scheduler.
        description: >
          Parsed from the event payload, run reason provided by the job scheduler.
      - name: job_run_started_at
        description: >
          Parsed from the event payload, the start time of the job run responsible for delivering a webhook event.
      - name: job_run_status
        description: >
          Parsed from the event payload, the run status provided by the job scheduler.
      - name: job_run_status_code
        description: >
          Parsed from the event payload, the run status code provided by the job scheduler.
      - name: job_run_status_message
        description: >
          Parsed from the event payload, the status message provided by the job scheduler.
      - name: trigger_event_type
        description: >
          Completed is for when a run is completed, started is for when a run has just started, errored is when a run has errored out, cancelled is when a run is canceled (either user or system canceled)
      - name: request_status_code
        description: >
          HTTP status code of the request made to dispatch webhook events.
      - name: request_headers
        description: >
          The headers supplied with the initial event.
      - name: request_body
        description: >
          The request body supplied with the initial event.
      - name: response_status_code
        description: >
          HTTP status code of the response.
      - name: error_info
        description: >
          Error information, if available.
      - name: response_body
        description: >
          The json string of thereturned response from the client url.
      - name: created_at
        tests:
          - not_null
        description: >
          Timestamp of when the event was created.
      - name: updated_at
        description: >
          Timestamp of when the webhook was last updated.
      - name: dispatched_at
        description: >
          Timestamp of when event was dispatched.
      - name: response_received_at
        description: >
          Timestamp of when the response was received.

  - name: dim_cloud_projects
    description: >
      Project data related to versioning and adapters as well as foreign keys to repos and accounts
    columns:
      - name: project_id
        description: System-generated unique identifier for the project entity
        tests:
          - unique
          - not_null
      - name: name
        description: User-defined name of the dbt project
        tests:
          # - unique: Plenty of overlap among teams (analytics, jaffle-shop, etc)
          - not_null
      - name: account_id
        description: System-generated unique identifier for the account entity
        tests:
          # - unique: an account can have multiple projects
          - not_null
      - name: repository_id
        description: System-generated unique identifier for the repository entity
        # tests:
        # - unique: multiple projects can be on one repo
        # - not_null: Over 60K nulls
      - name: instance_name
        tests:
          - not_null
      - name: adapter_count
        description: A count of distinct data warehouse adapters used within the project (possibly across several connections)
        # tests:
        # - unique: counts can duplicate
        # - not_null: can be null if connection to project doesn't exist
      - name: adapters_used
        description: A list of the data warehouse adapters used within the project (possibly across several connections)
        # tests:
        # - unique: Plenty of overlap with our partners
        # - not_null: can be null if connection to project doesn't exist
      - name: first_connection_created_at
        description: Timestamp of initial connection for the project
        # tests:
        # - unique: Timestamps can overlap
        # - not_null: can be null if connection to project doesn't exist
      - name: last_connection_created_at
        description: Timestamp of most recent connection for the project
        # tests:
        # - unique: Timestamps can overlap
        # - not_null: can be null if connection to project doesn't exist
      - name: min_dbt_version
        description: The earliest dbt version tracked in the history of the project
        # tests:
        # - unique: Versions are used across organizations
        # - not_null: Over 50K nulls
      - name: max_dbt_version
        description: The latest dbt version tracked in the history of the project
        # tests:
        # - unique: Versions are used across organizations
        # - not_null: Over 50K nulls
      - name: created_at
        description: Timestamp of the project creation
        tests:
          - not_null
      - name: updated_at
        description: Timestamp of the most recent update
        tests:
          - not_null

  - name: dim_cloud_semantic_layers
    description: >
      Each row represents a semantic layer workspace that has been spun up for a dbt Cloud customer,
      along with the associated information relevant to that workspace
    columns:
      - name: semantic_layer_id
        description: The unique id for the semantic layer workspace
        tests:
          - unique
          - not_null
      - name: semantic_layer_slug
        description: The unique slug that is prepended to the url used for connection
      - name: semantic_layer_enabled
        description: >
          An indicator of whether the workspace remains spun up as of the most recent 
          refresh of the data. This is current point-in-time despite the historical records in
          this model.
      - name: account_plan
        description: '{{ doc("cloud_plan") }}'

      - name: account_plan_tier
        description: '{{ doc("cloud_plan_tier") }}'

  - name: fct_cloud_account_activities
    description: >
      {{ doc('fct_cloud_account_activities') }}
    columns:
      - name: id
        description: The unique identifier of the combination of date and cloud account.
        tests:
          - unique
          - not_null
        meta:
          primary-key: true
      - name: account_id
        description: The unique identifier of the dbt Cloud account
        tests:
          - not_null
      - name: date_day
        description: The calendar date of cloud activity being summarized.
        tests:
          - not_null
      - name: tenant_account_id
        description: >
          The unique identifier of the dbt Cloud account within the context of
          a specific Single Tenant instance. This field can create duplicates
          from one ST instance to another and thus a single account_id (in a 
          separate field).
      - name: stripe_customer_id
        description: The unique identifier of the stripe customer associated with the account.
      - name: is_account_first_day
        description: >
          A boolean indicator of whether a given date is the initial
          date of activity on the account.
      - name: days_since_account_first_day
        description: >
          A calculation off of the first day of an account to assess the age of
          the account.
      - name: database_source
        description: '{{ doc("database_source") }}'
      - name: database_type
        description: >
          An indicator of whether the instance is multi-tenant or single-tenant.
      - name: name
        description: >
          The name of the cloud account defined at setup.
      - name: plan
        description: >
          The pricing plan set up for the account (e.g. developer, team, enterprise).
      - name: read_only_seats
        description: >
          The count of seats allotted to read-only users.
      - name: developer_seats
        description: >
          The count of seats allotted to developers.
      - name: is_account_feature_flag_deleted
        description: >
          The count of seats allotted to developers.
      - name: is_locked
      - name: lock_reason
      - name: enterprise_authentication_method
      - name: is_sso
      - name: created_at
      - name: updated_at
      - name: salesforce_account_id
      - name: sfdc_parent_account_id
      - name: is_primary_cloud_account
      - name: added_developer_seats
      - name: added_read_only_seats
      - name: deleted_developer_seats
      - name: deleted_read_only_seats
      - name: added_environments
      - name: added_repos
      - name: added_jobs
      - name: total_job_runs
      - name: successful_job_runs
      - name: failed_job_runs
      - name: job_run_duration_in_s
      - name: total_count_pageviews
      - name: total_time_engaged_in_s
      - name: total_users
      - name: deployment_count_pageviews
      - name: deployment_time_engaged_in_s
      - name: deployment_count_run_history_pageviews
      - name: deployment_count_snapshot_freshness_pageviews
      - name: deployment_count_administrative_pageviews
      - name: deployment_run_history_time_engaged_in_s
      - name: deployment_snapshot_freshness_time_engaged_in_s
      - name: deployment_administrative_time_engaged_in_s
      - name: setup_count_pageviews
      - name: setup_count_invite_pageviews
      - name: setup_count_project_pageviews
      - name: setup_count_connection_pageviews
      - name: setup_count_environment_pageviews
      - name: setup_count_repo_pageviews
      - name: docs_count_sessions
      - name: docs_time_engaged_in_s
      - name: ide_count_active_users
      - name: ide_count_develop_sessions
      - name: ide_count_failed_develop_sessions
      - name: ide_count_total_sessions
      - name: ide_count_tab_views
      - name: ide_count_dbt_invocations
      - name: ide_successful_invocations
      - name: ide_compiled_sql_events
      - name: ide_run_sql_events
      - name: ide_count_dbt_queries_run
      - name: ide_count_page_refreshes
      - name: ide_time_engaged_in_s
      - name: ide_usage_duration_in_s
      - name: first_paid_self_service
      - name: first_paid_enterprise
      - name: count_semantic_layer_environments_created
        description: >
          A count of semantic layer environments created for an account on that day.
      - name: count_semantic_layer_queries
      - name: count_of_invocations_with_metrics
        description: >
          A count of dbt core invocations using metrics models on that day.
      - name: is_active_job_runs
        description: >
          A flag (0 or 1) that tells us whether an account ran a job in Cloud
          (this includes successful/failed, scheduled, non-scheduled)
      - name: is_active_successful_job_runs
      - name: is_active_failed_job_runs
      - name: is_active_ide
        description: >
          A flag (0 or 1) that tells us whether an account was in the IDE
          on that day
      - name: is_active_login
        description: >
          A flag (0 or 1) that tells us whether an account logged into Cloud
          on that day
      - name: is_active_scheduled_runs
      - name: is_active_snapshot_freshness
      - name: is_active_docs
        description: >
          A flag (0 or 1) that tells us whether an account touched
          their account's docs on that day
      - name: is_active_setup_invite
        description: >
          A flag (0 or 1) that tells us whether an account viewed the form
          for inviting a new user on that day.
      - name: is_active_setup_project
        description: >
          A flag (0 or 1) that tells us whether an account viewed the form
          for creating a new project on that day.
      - name: is_active_setup_connection
        description: >
          A flag (0 or 1) that tells us whether an account viewed the form
          for creating a new warehouse connection on that day.
      - name: is_active_setup_environment
        description: >
          A flag (0 or 1) that tells us whether an account viewed the form
          for creating a new environment on that day.
      - name: is_active_setup_repo
        description: >
          A flag (0 or 1) that tells us whether an account viewed the form
          for creating a new repo on that day.
      - name: is_semantic_layer_active
        description: >
          A flag (0 or 1) that tells us whether an account queried the semantic 
          layer on that day.
      - name: is_active_metrics
        description: >
          A flag (0 or 1) that tells us whether an account ran invocations with
          metrics models on that day.
      - name: is_active
        description: >
          A flag (0 or 1) that indicates whether an account was considered
          active on that day. 
          {{ doc('active_cloud_account_definition') }}
      - name: ide_avg_session_time_per_user
      - name: ide_avg_session_time_per_active_user
      - name: last_active_date
      - name: is_user_last_login
      - name: t7d_active
        description: >
          A flag (0 or 1) to indicate whether an account is considered active
          within the trailing 7 days.
          {{ doc('active_cloud_account_definition') }}
      - name: t7d_job_active
        description: >
          A flag (0 or 1) to indicate whether an account ran a job in Cloud
          within the trailing 7 days
      - name: t7d_successful_job_active
      - name: t7d_ide_active
        description: >
          A flag (0 or 1) to indicate whether an account accessed the IDE
          within the trailing 7 days
      - name: t7d_semantic_layer_active
        description: >
          A flag (0 or 1) to indicate whether an account queried the semantic 
          layer within the trailing 7 days
      - name: t7d_job_runs
      - name: t7d_job_runs_successful
      - name: t7d_job_runs_failed
      - name: t7d_ide_sessions_successful
      - name: t7d_ide_sessions_failed
      - name: t7d_ide_sessions
        description: >
          The total number of IDE sessions an account had for the past
          7 trailing days
      - name: t7d_ide_time_engaged_in_s
        description: >
          The total time (in seconds) an account was engaged in the IDE
          over the past 7 trailing days. It is best looked on a daily level. If we
          want to aggregate this metric (e.g. by week), then this metric should be
          averaged.
      - name: t7d_login_active
        description: >
          A flag (0 or 1) to indicate whether an account logged into Cloud
          within the trailing 7 days
      - name: t7d_docs_active
        description: >
          A flag (0 or 1) to indicate whether an account had a docs
          session within the trailing 7 days
      - name: t7d_docs_sessions
        description: >
          The total number of docs sessions an account had for the past
          7 trailing days
      - name: t7d_docs_time_engaged_in_s
        description: >
          The total time (in seconds) an account spent in the Docs over
          the past 7 trailing days. It is best looked on a daily level. If we want
          to aggregate this metric (e.g. by week), then this metric should be averaged.
      - name: t7d_semantic_layer_queries
        description: >
          The total number of successful semantic layer queries (using dbt sql)
          over the past 7 trailing days.
      - name: t30d_active
        description: >
          A flag (0 or 1) to indicate whether an account is considered active
          within the trailing 30 days.
          {{ doc('active_cloud_account_definition') }}
      - name: t30d_job_active
      - name: t30d_successful_job_active
      - name: t30d_ide_active
        description: >
          A flag (0 or 1) to indicate whether an account accessed the IDE
          within the trailing 30 days
      - name: t30d_semantic_layer_active
        description: >
          A flag (0 or 1) to indicate whether an account queried the semantic 
          layer within the trailing 30 days
      - name: t30d_ide_sessions
        description: >
          The total number of ide sessions an account had for the past
          30 trailing days
      - name: t30d_ide_sessions_successful
      - name: t30d_ide_sessions_failed
      - name: t30d_ide_time_engaged_in_s
        description: >
          The total time (in seconds) an account was engaged in the IDE
          over the past 30 trailing days. It is best looked on a daily level. If we
          want to aggregate this metric (e.g. by week), then this metric should be
          averaged.
      - name: t30d_login_active
        description: >
          A flag (0 or 1) to indicate whether an account logged into Cloud
          within the trailing 30 days
      - name: t30d_docs_active
        description: >
          A flag (0 or 1) to indicate whether an account had a docs
          session within the trailing 30 days
      - name: t30d_docs_sessions
        description: >
          The total number of docs sessions an account had for the past
          30 trailing days
      - name: t30d_docs_time_engaged_in_s
        description: >
          The total time (in seconds) an account spent in the Docs over
          the past 30 trailing days. It is best looked on a daily level. If we want
          to aggregate this metric (e.g. by week), then this metric should be averaged.
      - name: t30d_semantic_layer_queries
        description: >
          The total number of successful semantic layer queries (using dbt sql)
          over the past 30 trailing days.
      - name: t30d_job_runs
      - name: t30d_job_runs_successful
      - name: t30d_job_runs_failed
      - name: cumulative_semantic_layer_environments_created
        description: >
          A running count of semantic layer environments created for an account on or before that day.
      - name: is_last_record

  - name: fct_cloud_api_requests
    description: >
      Attempted API requests against dbt Cloud APIs with account plans,
      partner connect sources and user licenses if applicable.
    columns:
      - name: event_id
        tests:
          - unique
          - not_null
      - name: method
        description: >
          The HTTP request method (e.g. GET or POST).
      - name: path
        description: >
          The path used in the API request.
      - name: query_params
        description: >
          An object that contains a mapping of the query parameters used in this
          request, to the values that were passed. A request like
          `/api/foo?param=value`, would result in an object like this `{"param": "value"}`.
      - name: user_agent
        description: >
          The user agent that was pulled from the HTTP headers.
      - name: api_version
        description: >
          The API version that was used. This is also included in the path.
      - name: auth_type
        description: >
          The authentication method used for the API request (i.e. API token or session cookie).
      - name: request_at
        description: >
          A timestamp indicating when the request was made.
      - name: has_query_pagination
        description: >
          A boolean indicating whether or not the request had a limit and an offset specified.
          If both of these query parameters are present, then we are assuming that the caller
          is paging through results.
      - name: query_param_limit
        description: >
          The limit query parameter used (if any).
      - name: query_param_offset
        description: >
          The offset query parameter used (if any).
      - name: query_param_include_related
        description: >
          The include_related query parameter used (if any).
      - name: query_param_order_by
        description: >
          The order_by query parameter used (if any).
      - name: account_plan
        description: '{{ doc("cloud_plan") }}'
      - name: account_plan_tier
        description: '{{ doc("cloud_plan_tier") }}'
      - name: database_source
        description: '{{ doc("database_source") }}'
      - name: tenant_user_id
        description: Identifier of a dbt Cloud user in the given dbt Cloud instance
      - name: tenant_account_id
        description: >
          Deployment-specific cloud account ids.

  - name: fct_cloud_account_events
    columns:
      - name: id
        tests:
          - unique
          - not_null
        meta:
          primary-key: true

  - name: fct_cloud_accounts
    description: >
      Address data is pulled from Stripe (if available) then Salesforce (if available).
      Cloud accounts that never were signed up via Stripe (i.e., on a Team plan), will
      never have data from Stripe.
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - instance_name
            - tenant_account_id
    columns:
      - name: account_id
        tests:
          - unique
          - not_null
      - name: instance_name
        tests:
          - not_null
      - name: cc_failure_message
        description: >
          Indicates if a self-service account's credit card payments are declining.
          If it is still declining 30 days after their last invoice date, then we
          will no longer contact them.
      - name: array_dbt_versions_used
        description: >
          This indicates all dbt versions reflected in cloud jobs set up for
          the account.
      - name: current_deployment_stage
        description: >
          This allows us to see what deployment stage an account is currently in.
          There are four deployment stages for a Cloud account: 
          1. Sign-Up, 
          2. Onboarded (Connected warehouse and repo), 
          3. Successful Invocation, 
          4. Created job, 
          5. Successful job run
      - name: days_to_current_deployment_stage
        description: >
          A calculated field that lets us know how many days it took for a Cloud
          account to go from creation to their latest deployment stage.
      - name: enterprise_authentication_method
        description: >
          This field lets us know if an Enterprise account has SSO enabled on their
          account. If they do, we will know their auth provider and if it's supported
          via our native integration or the legacy Auth0 method.
      - name: address_city
        description: >
          The address city of the Cloud account according to Stripe (if available) or
          Salesforce (if available).
      - name: address_state
        description: >
          The address state of the Cloud account according to Stripe (if available) or
          Salesforce (if available).
      - name: address_zip
        description: >
          The address zip/postal code of the Cloud account according (if available) or
          Salesforce (if available).
      - name: address_country
        description: >
          The address country of the Cloud account according to Stripe (if available) or
          Salesforce (if available).
      - name: billing_name
        description: >
          The billing name of the Cloud account according to Stripe (if available).
      - name: billing_email
        description: >
          The billing email of the Cloud account according to Stripe (if available).
      - name: address_line_1
        description: >
          The address (line 1) of the Cloud account according to Stripe (if available).
      - name: address_line_2
        description: >
          The address (line 2) of the Cloud account according to Stripe (if available).
      - name: address_string
        description: >
          The address string of the Cloud account according to Stripe (if available).
      - name: has_service_token
        description: Indicates whether or not the Cloud account has an active service token.
      ## None of the AARRR metrics should be anything other than 1 or 0 - a null means something's broken
      - name: has_successful_session
        tests:
          - not_null
      - name: has_successful_invocation
        tests:
          - not_null
      - name: has_compiled_sql
        tests:
          - not_null
      - name: has_run_sql
        tests:
          - not_null
      - name: has_outbound_webhook
        description: >
          An indicator of whether or not a given account has at triggered at least one outbound webhook event.
      - name: has_delivered_outbound_webhook
        description: >
          An indicator of whether or not a given account has had a successfully delivered outbound webhook event.
      - name: has_metrics
        description: >
          An indicator of whether or not a given account is currently using metrics functionality
          Note: metrics are not the entire semantic layer experience, which includes using the proxy 
          server so a further flag will need to be developed later.
      - name: has_semantic_layer_environment
        description: >
          An indicator of whether or not a given account has at least one semantic layer workspace.
      - name: has_successful_semantic_layer_run
        description: >
          An indicator of whether or not a given account has at least one run using a semantic 
          layer workspace.
      - name: is_semantic_layer_eligible
        description: >
          An indicator of whether or not a given account is eligible to use the Semantic Layer based
          on permanent criteria (e.g. not a test account) and temporary criteria (e.g. Snowflake only)
      - name: has_used_semantic_layer
        description: >
          An indicator of whether or not a given account has run at least one successful dbt-sql
          query on the semantic layer.
      - name: has_external_metadata_api_requests
        description: >
          '{{ doc('has_external_metadata_api_requests') }}'
      - name: has_created_deployment_environment
        description: A boolean that indicates if the account has ever had a deployment environment.
      - name: cloud_activation_due_at
        description: Timestamp to indicate the day in which the Cloud Account is due for activation (i.e. 14 days after its creation date)
      - name: first_cloud_activated_at
        description: The timestamp when the Cloud Account reached 100+ invocations within dbt Cloud
      - name: did_reach_activation_threshold
        description: >
          A boolean (true/false) that indicates whether the Cloud Account reached activation within
          the threshold. This is defined as: the Cloud Account has connected a warehouse, repository,
          and reached 100+ invocations within 14 days of its creation.
      - name: stale_account
        description: >
          Indicates if an account's last successful inovcation was greater than 180 days ago.
          Note: an account can only be considered stale if it has had at least 1 successful invocation.

      - name: cc_expiration_date
        description: The date in which the credit card on the account's most recent invoice is set to expire.
        tests:
          - not_null:
              config:
                where: "plan ilike 'team%' and is_account_deleted = 0 and is_locked = false and first_paid_at::date < current_date()"

      - name: days_to_cc_expiration
        description: >
          The number of days between the current date and when the account's credit card will expire.
          This is used by the customer success & marketing teams to send proactive communications to clients
          letter them know to update their credit card.
      - name: all_time_project_count
        description: >
          A count of distinct cloud projects set up by the account, including active & deleted projects.
          Note that this does not represent the count of core projects that may be associated with the account.
          This field can be null prior to project connections.
      - name: current_project_count
        description: >
          A count of distinct cloud projects set up by the account that are active (not deleted).
          Note that this does not represent the count of core projects that may be associated with the account.
          This field can be null prior to project connections.
      - name: all_time_deployment_environment_count
        description: >
          The distinct count of deployment environments created within the account, including both active & deleted environments.
      - name: current_project_count
        description: >
          The distinct count of active (not deleted) deployment environments created within the account.
      - name: adapter_count
        description: A count of distinct data warehouse adapters used within the account (possibly across several projects)
        # tests:
        # - unique: counts can duplicate
        # - not_null: can be null if connection to account's projects doesn't exist
      - name: adapters_used
        description: A list of the data warehouse adapters used within the account (possibly across several projects)
        # tests:
        # - unique: Plenty of overlap with our partners
        # - not_null: can be null if connection to account's projects doesn't exist
      - name: first_connection_created_at
        description: Timestamp of initial connection for the account
        # tests:
        # - unique: Timestamps can overlap
        # - not_null: can be null if connection to account's projects doesn't exist
      - name: last_connection_created_at
        description: Timestamp of most recent connection for the account
        # tests:
        # - unique: Timestamps can overlap
        # - not_null: can be null if connection to account's projects doesn't exist
      - name: first_successful_ide_invocation_at
        description: Invocation start timestamp of any first successful IDE invocation
      - name: last_successful_ide_invocation_at
        description: Most recent invocation start timestamp of any successful IDE invocation
      - name: min_dbt_version
        description: The earliest dbt version tracked in the job history of the account
        # tests:
        # - unique: N/A - versions can be used in multiple accounts across organizations
        # - not_null: N/A - cloud accounts can be set up without jobs in place
      - name: max_dbt_version
        description: The latest dbt version tracked in the job history of the account
        # tests:
        # - unique: N/A - versions can be used in multiple accounts across organizations
        # - not_null: N/A - cloud accounts can be set up without jobs in place
      - name: is_reseller_acct
        description: >
          A boolean that indicates if a dbt Cloud account is a part of a resller program.
          Reseller accounts are billed different than typical team accounts.
          There are not yet mechanisms in place to monitor billing for these accounts, as of December 2022.
          As such, these accounts should be excluded from any formal communication to team customers.
      - name: is_test_account
        description: >
          A boolean that indicates if a dbt Cloud account is a test account. The data team infers test accounts
          by string matching account names against discrete criteria, defined in stg_cloud__accounts. 
      - name: is_internal_account
        description: >
          A boolean that indicates if a dbt Cloud account is a known account of an internal user. The data team
          identifies internal cloud accounts that are mapped to internal Salesforce Accounts in Salesforce. 
          For details, see mapping logic in cloud_account_mappings model.
      - name: plan_tier
        description: >
          The tier of plan a Cloud account is on, irregardless of the plan version.
          For example, a `team` and `team_2022` plan are both considered `plan_tier = team`.
          This field is a result of us having multiple versions of plans as of the December 2022 pricing change.
      - name: database_source
        description: '{{ doc("database_source") }}'
      - name: last_touch_conversion_channel
        description: >
          The referring Channel of the website session in which the Cloud account was created.
          Note: conversion information is only available for accounts created via an online sign up.
          This means that only the first account created for a user is considered in this field.
      - name: last_touch_conversion_campaign
        description: >
          The referring Marketing Campaign of the website session in which the Cloud account was created.
          Note: conversion information is only available for accounts created via an online sign up.
          This means that only the first account created for a user is considered in this field.
      - name: slug
        description: >
          Enterprise SSO slug of the account. This value is only populated for Enterprise plan accounts
      - name: identity_provider
        description: >
          Identity provider for org. Accepted values are saml, okta, azure_multi_tenant, azure_single_tenant, gsuite. 
          This value is only populated for Enterprise plan accounts
      - name: auth_provider_updated_at
        description: >
          Last updated time of the identity provider configuration. This value is only populated for Enterprise accounts 
      - name: auth0_migration_status
        description: >
          Migration status for the Auth0 SSO IdP migration. This value is only populated for Enterprise accounts. 

          


  - name: fct_cloud_ide_active_session_timing
    description: >
      This model represents our best guess of startup timing for every active IDE session.
      An "Active IDE Session" here means any unique startup series. A startup active session 
      could either be cold, warm, or hot starts. For more information on the types of startups
      feel free to reference the IDE 1.1 Metrics planning doc 
      [Metrics: Startup, Interaction, Reliability](https://www.notion.so/dbtlabs/Metrics-Startup-Interaction-Reliability-150aa4d9c209460897de60c4559b4e33).
    columns:
      - name: startup_id
        tests:
          - unique
          - not_null

  - name: fct_cloud_ide_interaction_timing
    description: >
      This model represents timing information on specific interactions that occur in the 
      dbt Cloud IDE. Interactions are specific behaviors that we explicitly want to track
      and the list of interactions will continue to evolve over time. We track timing
      information here in the magnitude of milliseconds.
    columns:
      - name: interaction_id
        tests:
          - unique
          - not_null

  - name: fct_cloud_ide_sessions
    columns:
      - name: develop_request_id
        tests:
          - unique
          - not_null
      - name: user_session_index
        description: A running index of the number of sessions a user has ever had historically.
      - name: user_successful_session_index
        description: A running index of number of successful sessions a user has ever had historically.

  - name: fct_cloud_project_connections
    description: >
      This model captures specific cloud project connections along with the associated adapter, project, and account
    columns:
      - name: connection_id
        tests:
          - unique
        # - not_null --Confirmed nearly 1000 connection_ids are NULL

  - name: fct_cloud_run_metrics
    columns:
      - name: unique_id
        tests:
          - unique
          - not_null

  - name: fct_cloud_user_account_activities
    description: >
      This model reports on daily user activity. Activity is broken down
      into pageview + time-on-site metrics for each use-case that is
      is addressed in dbt Cloud (ie. Deployment and Development)
    columns:
      - name: id
        tests:
          - unique
          - not_null
        meta:
          primary-key: true
      - name: account_id
        tests:
          - not_null
      - name: is_active
        description: >
          A flag (0 or 1) that tells us whether a user on an account logged into Cloud
          on that day
      - name: is_docs_active
        description: >
          A flag (0 or 1) that tells us whether a user on an account touched
          their account's docs on that day
      - name: is_ide_active
        description: >
          A flag (0 or 1) that tells us whether a user on an account was in the IDE
          on that day
      - name: is_active_setup_invite
        description: >
          A flag (0 or 1) that tells us whether an account viewed the form
          for inviting a new user on that day.
      - name: is_active_setup_project
        description: >
          A flag (0 or 1) that tells us whether an account viewed the form
          for creating a new project on that day.
      - name: is_active_setup_
        description: >
          A flag (0 or 1) that tells us whether an account viewed the form
          for creating a new warehouse connection on that day.
      - name: is_active_setup_environment
        description: >
          A flag (0 or 1) that tells us whether an account viewed the form
          for creating a new environment on that day.
      - name: is_active_setup_repo
        description: >
          A flag (0 or 1) that tells us whether an account viewed the form
          for creating a new repo on that day.
      - name: t7d_active
        description: >
          A flag (0 or 1) to indicate whether a user on an account logged into Cloud
          within the trailing 7 days
      - name: t7d_ide_active
        description: >
          A flag (0 or 1) to indicate whether a user on an account accessed the IDE
          within the trailing 7 days
      - name: t7d_ide_sessions
        description: >
          The total number of IDE sessions a user on an account had for the past
          7 trailing days
      - name: t7d_ide_time_engaged_in_s
        description: >
          The total time (in seconds) a user on an account was engaged in the IDE
          over the past 7 trailing days. It is best looked on a daily level. If we
          want to aggregate this metric (e.g. by week), then this metric should be
          averaged.
      - name: t7d_docs_active
        description: >
          A flag (0 or 1) to indicate whether a user on an account had a docs
          session within the trailing 7 days
      - name: t7d_docs_sessions
        description: >
          The total number of docs sessions a user on an account had for the past
          7 trailing days
      - name: t7d_docs_time_engaged_in_s
        description: >
          The total time (in seconds) a user on an account spent in the Docs over
          the past 7 trailing days. It is best looked on a daily level. If we want
          to aggregate this metric (e.g. by week), then this metric should be averaged.
      - name: t30d_active
        description: >
          A flag (0 or 1) to indicate whether a user on an account went into Cloud
          within the trailing 30 days
      - name: t30d_ide_active
        description: >
          A flag (0 or 1) to indicate whether a user on an account went accessed IDE
          within the trailing 30 days
      - name: t30d_ide_sessions
        description: >
          The total number of ide sessions a user on an account had for the past
          30 trailing days
      - name: t30d_ide_time_engaged_in_s
        description: >
          The total time (in seconds) a user on an account was engaged in the IDE
          over the past 30 trailing days. It is best looked on a daily level. If we
          want to aggregate this metric (e.g. by week), then this metric should be
          averaged.
      - name: t30d_docs_active
        description: >
          A flag (0 or 1) to indicate whether a user on an account had a docs
          session within the trailing 30 days
      - name: t30d_docs_sessions
        description: >
          The total number of docs sessions a user on an account had for the past
          30 trailing days
      - name: t30d_docs_time_engaged_in_s
        description: >
          The total time (in seconds) a user on an account spent in the Docs over
          the past 30 trailing days. It is best looked on a daily level. If we want
          to aggregate this metric (e.g. by week), then this metric should be averaged.

  - name: fct_cloud_user_account_mappings
    description: This model maps a Cloud user, the active accounts they're assoicated with, and their permission groups within those accounts.
    columns:
      - name: user_account_id
        tests:
          - unique
          - not_null
      - name: user_account_association_created_at
        description: >
          A timestamp for the earliest date at which a specific user-account association was created via a license.
      - name: user_account_association_last_updated_at
        description: >
          A timestamp for the latest date at which a specific user-account association was updated via license activity.
      - name: user_license_account_index
        description: >
          A running index of the number of licenses a user has per Salesforce Account (if they don't have a
          Salesforce Account, then overall). This is prioritized by their primary accounts and then ordered
          by when they were given a license. This is mainly used in Looker to dedupe single-tenant users if
          they're on multiple Cloud Accounts.
      - name: is_first_associated_account
        description: >
          An indicator of the first account a user has per Salesforce Account (if they don't have a
          Salesforce Account, then overall). This is based on user_license_account_index
      - name: user_account_creation_index
        description: >
          A running index of the number of accounts a user has created.
      - name: account_membership_index
        description: >
          A running index of the order in which users have been associated with an account.
      - name: user_account_relationship
        description: >
          A descriptor of the nature of a user's association with an account.
      - name: groups
        description: An array of the permission groups the user is asociated with on a specific account.
      - name: sso_mapping_groups
        description: An array of SSO groups the user is associated with on a specific account.
      - name: plan
        description: '{{ doc("cloud_plan") }}'

      - name: plan_tier
        description: '{{ doc("cloud_plan_tier") }}'

  - name: fct_cloud_user_activity
    description: >
      {{ doc('fct_cloud_user_activity') }}
    columns:
      - name: id
        tests:
          - not_null
          - unique
      - name: date_day
        tests:
          - not_null
      - name: user_id
        tests:
          - not_null
      - name: is_active
        description: User has pageviews on that day.
      - name: is_active_docs_warehouse
        description: User has viewed warehouse-specific docs pages (profiles or configs) on that day.
      - name: is_active_docs_tutorial
        description: User has viewed docs pages in the /tutorial/ subfolder on that day.
      - name: is_active_training
        description: User has viewed on-demand course lesson pages on that day.

  - name: fct_cloud_users
    description: >
      This model contains one record per dbt Cloud users with enrichments aggregated at the user level.
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - instance_name
            - tenant_user_id
    columns:
      - name: user_id
        description: >
          Unique identifier of a dbt Cloud user.
          Corresponds either to: - the id of the user in the North America multi-tenant
          dbt Cloud instance - the hash of the concatenation of `database_source` and id of the user in 
          single-tenant or other multi-tenant dbt Cloud instances
        tests:
          - unique
          - not_null

      - name: salesforce_contact_id
        description: The users Salesforce Contact ID.

      - name: database_schema
        description: Name of the Snowflake schema regrouping the raw extracted dbt Cloud instance data

      - name: database_source
        description: '{{ doc("database_source") }}'

      - name: database_type
        description: Type of deployment used for the dbt Cloud instance (multi tenant or single tenant)

      - name: tenant_user_id
        description: Identifier of a dbt Cloud user in the given dbt Cloud instance

      - name: email
        description: The user's email address.

      - name: first_name
        description: The user's first name.

      - name: last_name
        description: The user's last name.

      - name: name
        description: The user's full name.

      - name: email_top_level_domain
        description: The final part of the user's email address. For example, `test.user@dbtlabs.com`` would produce `com`

      - name: is_active
        description: A boolean that determines if a user is still existing in dbt Cloud

      - name: is_staff
        description: A boolean that indicates if a user is dbt Labs staff. This is determined on the backend of dbt Cloud.

      - name: is_superuser
        description: A boolean that indicates if a user has superuser privileges in dbt Cloud. This is determined on the backend of dbt Cloud.

      - name: is_fishtown_user
        description: A boolean that indicates if a user has an @dbtlabs.com or @fishtownanalytics.com email.

      - name: date_joined__og
        description: The timestamp in which the user was created in dbt Cloud, in their local timezone.

      - name: date_joined__ntz
        description: The timestamp in which the user was created in dbt Cloud, in UTC.

      - name: last_login
        description: A timestamp indicating when the user last logged into dbt Cloud.

      - name: is_verified
        description: >
          A boolean value that indicates if a user has verified their email address.
          Note: all single tenant users are considered verified.

      - name: first_email_verification_sent_at
        description: >
          A timestamp of when the users first email verification was sent.
          Note: this does not ensure a user is verified - only that they received communication.

      - name: first_verified_at
        description: A timestamp indicating when a user first verified their email.

      - name: last_verified_at
        description: A timestamp indicating when a user last verified their email.

      - name: count_associated_accounts
        description: >
          This field indicates the count of accounts that a user has an active
          license (either developer or read-only) with.

      - name: count_created_accounts
        description: >
          This field indicates the count of accounts that a user created

      - name: count_ide_sessions
        description: This only reflects IDE sessions that have successfully completed

      - name: first_ide_session_at
        description: This only reflects IDE sessions that have successfully completed

      - name: last_ide_session_at
        description: This only reflects IDE sessions that have successfully completed

      - name: instance_name
        description: >
          The name of the instance defined by the `POD_NAMESPACE` environment variable. 
          This is defined in each tenant's helm chart like so: 
          https://github.com/dbt-labs/helm-charts/blob/main/releases/ally/cloud/main.yaml#L5
        tests:
          - not_null

      - name: sign_up_source
        description: >
          The sign_up_source (i.e. dbt Cloud, Snowflake Partner Connect, Databricks Partner Connect)
          from the user's most recent cloud acount license.

      - name: self_service_account_member_count
        description: The number of Cloud accounts the user is a member of.

      - name: self_service_account_owner_count
        description: The number of Cloud accounts the user is the owner of.

      - name: feature_flags
        description: An array of any feature flags enabled for the user.
      
      - name: attended_courses
        description: A JSON object of any dbt Learn courses the user has attended.

      - name: is_valid_email_address
        description: >
          A boolean field that indicates if a user's email address is deemed valid by RFC 2282 standard.
          A valid email includes only accepted username characters (i.e. letters, numbers, underscores, plus signs, etc.)
          and has a top level domain under the globally accepted domains list.

      - name: enrolled_in_learn
        description: A boolean field that indicates if a user has enrolled in a dbt Learn course.

      - name: is_trained
        description: A boolean field to communicate if a user has completed a learn course.

      - name: is_account_creator
        descrition: A boolean that indicates if the user has created a dbt Cloud account.

  - name: dim_cloud_environments
    description: >
      This table contains one record per dbt Cloud Environment. Environments come in two
      flavors - "Development" and "Deployment". Development environments _do not contain creds_
      and are used to power IDE sessions. Deployment environments _do contain creds_ and are used
      for scheduled runs. Each Environment belongs to a dbt Cloud Project. This
      table also includes summarized information about environment variables that
      apply to this environment.
    columns:
      - name: environment_id
        tests:
          - unique
          - not_null
      - name: count_environment_variables
        description: >
          This field indicates the count of environment variables actively
          configured in this environment.
      - name: configured_environment_variables
        description: >
          This field has the array of active environment variable names that are
          configured in this environment. This field can be used with 
          `array_intersection()` to be able to identify environment variable 
          overides at the job or user level.

  - name: fct_cloud_user_group_permissions
    description: "{{ doc('fct_cloud_user_group_permissions') }}"
    columns:
      - name: user_group_permission_id
        tests:
          - unique
          - not_null
      - name: database_type
        description: Indicates if the permissions are sourced from a multi-tenant or single-tenant account
      - name: license_type
        description: The license type assigned to the user in the account
      - name: group_name
        description: >
          A group is a collection of users.
          Users may belong to multiple groups.
          Members of a group inherit any permissions applied to the group itself.
      - name: permission_set
        description: >
          Permission sets are predefined collections of granular permissions.
          Permission sets combine low-level permission grants into high-level roles that can be assigned to groups.
      - name: is_all_projects
        description: A boolean field (true/false) that indicates if the permission set applies to all projects within the account.

  - name: dim_cloud_tenants
    description: >
      This models unions single tenants & multi-tenants into one place with their 
      associated database source and other information. Each record represents 1 single-tenant.
    columns:
      - name: instance_name
        tests:
          - unique
          - not_null
      - name: database_source
        tests:
          - unique
          - not_null
      - name: database_type
        description: Is this a single_tenant or a multi_tenant database?
      - name: instance_name_md5
        description: MD5 hash of instance_name. For Hightouch sync key use with Jira.
        tests:
          - unique
          - not_null

  - name: export_jira_dim_cloud_tenants
    description: >
      Based on the dim_cloud_tenants model, this model joins and adds additional enhancements from other tables.
      The goal is that this model follows deletions the same as the dim_cloud_tenants model.
      It is intended to be used via Hightouch for pushing information to information records in Jira.
      The primary key for Jira is an MD5 hash of instance_name.
    columns:
      - name: instance_name
        tests:
          - unique
          - not_null
      - name: database_source
        tests:
          - unique
          - not_null
      - name: instance_name_md5
        description: MD5 has of instance_name.  For Hightouch sync key use with Jira.
        tests:
          - unique
          - not_null