version: 2

models:
  - name: fct_arr_waterfall
    description: '{{ doc("fct_arr_waterfall") }}'
    columns:
      - name: close_month
        description: Month in which ARR was active/ARR Movements occurred. Values prior to 1/31/2021 have all been aggregated to 1/31/2021 in accordance with our financial timeline
        tests:
          - not_null
      - name: is_current_month
        description: Flags the current month to exclude in any financial reporting
      - name: is_quarter_end
        description: Flags the months that are end of the fiscal quarter
      - name: customer_name
        description: The customer in question
      - name: sales_channel
        description: Managed or Self-Serve. Proxy for Sales_Motion field in fct_cloud_subscription_transactions, transformed to align with financial models
      - name: starting_arr
        description: Prior Month's ending ARR
      - name: gross_arr_total
        description: New ARR, Upgrade ARR, Reactivation ARR, and Enterprise Upgrade ARR
      - name: churn_arr_total
        description: Churned ARR, Downgrade ARR 
      - name: ending_arr
        description: ARR on final day of the month
      - name: walk_delta
        description: Ending ARR - sum(Starting ARR + Gross ARR Total + Churn ARR Total) - delta between the calculated movements and what the final value should be. We will establish an acceptable accuracy range based on this number

  - name: fct_subscription_customer_arr_events
    description: '{{ doc("fct_subscription_customer_arr_events") }}'
    columns:
      - name: id
        tests:
          - unique
          - not_null
      - name: close_month
        description: Month in which ARR was active/ARR Movements occurred
        tests:
          - not_null
      - name: is_current_month
        description: Flag for if close_month is equal to current month the query ran
      - name: is_end_of_quarter
        description: Flag for id close_month is the final month in a fiscal quarter
      - name: customer_id
        description: Customer ID from fct_cloud_subscription_transactions table
      - name: customer_name
        description: Customer Name from fct_cloud_subscription_transactions table
      - name: sales_channel
        description: Modified sales_motion from fct_cloud_subscription_transactions table
      - name: metric_category
        description: arr_balance or arr_delta
      - name: metric
        description: Detailed metric of arr_balance or arr_delta
      - name: metric_value
        description: The value of the given metric

  - name: dim_finance_roster
    description: '{{ doc("dim_finance_roster") }}'
    columns:
      - name: job_id
        tests:
          - unique
          - not_null
      - name: plan_hire_date
        description: Planned hire date from Finance forecast in Pigment
      - name: offer_hire_date
        description: Hire date tied to accepted offer in Greenhouse
      - name: adp_hire_date
        description: Hire date for active employee in ADP
      - name: hire_date
        description: All hire dates coalesced to one field in the following order - (ADP, Greenhouse, Finance Plan)
      - name: adp_termination_date
        description: Termination date in ADP that is populated on that date
        meta:
          masking_policy: finance_date
      - name: adp_custom_termination_date
        description: Custom text field used to forecast Termination Date given adp_termination_date cannot be populated for future dated terminations
        meta:
          masking_policy: finance_date
      - name: termination_date
        description: adp_termination_date and adp_custom_termination_date coalesced to actualize future dated terminations with correct field coming from ADP
        meta:
          masking_policy: finance_date
      - name: finance_termination_date
        description: termination_date + 1. Terminations often come at the end of the month. In this case we want to forecast the termination for the following month given that is when the change in expenses actually occurs
        meta:
          masking_policy: finance_date
      - name: plan_salary_country
        description: This is primarily a check column to ensure that we are joining the compensation band assumptions to countries correctly
      - name: plan_hiring_country
        description: Country that headcount was planned to be hired in in the Finance Plan in Pigment
      - name: opening_hiring_country
        description: Country that the opening for the job was actually created in in Pigment, this may change for EU countries during the recruiting process
      - name: offer_accepted_hiring_country
        description: Hiring Country tied to an accepted offer in Greenhouse
      - name: adp_hiring_country
        description: Country that an active employee was hired in
      - name: hiring_country
        description: Hiring Country coalesced in the following order (ADP, Greenhouse Offer, Greenhouse Opening, Finance Plan)
      - name: opening_minimum_salary
        description: Taken from Greenhouse opening (not to be used in finance modeling but will be used to ensure we are opening job requisitions appropriately). Minimum of the salary range in local currency
        meta:
          masking_policy: finance_number
      - name: opening_midpoint_salary
        description: Taken from Greenhouse opening (not to be used in finance modeling but will be used to ensure we are opening job requisitions appropriately). Midpoint of the salary range in local currency
        meta:
          masking_policy: finance_number
      - name: opening_maximum_salary
        description: Taken from Greenhouse opening (not to be used in finance modeling but will be used to ensure we are opening job requisitions appropriately). Maximum of the salary range in local currency
        meta:
          masking_policy: finance_number
      - name: plan_salaries_min_salary
        description: Minimum of the Salary band by Job Function Code and Country based on Finance Plan, local currency
        meta:
          masking_policy: finance_number
      - name: plan_salaries_mid_salary
        description: Midpoint of the Salary band by Job Function Code and Country based on Finance Plan, local currency
        meta:
          masking_policy: finance_number
      - name: plan_salaries_max_salary
        description: Maximum of the Salary band by Job Function Code and Country based on Finance Plan, local currency
        meta:
          masking_policy: finance_number
      - name: opening_salaries_min_salary
        description: Minimum of the Salary band by Job Function Code and Country based on Greenhouse Opening, local currency
        meta:
          masking_policy: finance_number
      - name: opening_salaries_mid_salary
        description: Minimum of the Salary band by Job Function Code and Country based on Greenhouse Opening, local currency
        meta:
          masking_policy: finance_number
      - name: opening_salaries_max_salary
        description: Maximum of the Salary band by Job Function Code and Country based on Greenhouse Opening, local currency
        meta:
          masking_policy: finance_number
      - name: transfer_salary
        description: Salary tied to an incoming Employee via a transfer/internal offer
        meta:
          masking_policy: finance_number
      - name: offer_accepted_salary
        description: Salary tied to accepted offer in Greenhouse, Local Currency
        meta:
          masking_policy: finance_number
      - name: adp_salary
        description: Salary for active employees in ADP, Local Currency
        meta:
          masking_policy: finance_number
      - name: employee_salary
        description: Actual salary coalesced in the following order (ADP, Greenhouse Offer), Local Currency
        meta:
          masking_policy: finance_number

  - name: fct_managed_arr_forecast
    description: '{{ doc("fct_managed_arr_forecast") }}'
    columns:
      - name: opp_forecast_id
        tests:
          - unique
          - not_null

  - name: fct_arr_aggregated
    description: '{{ doc("fct_arr_aggregated") }}'
    columns:
      - name: aggregated_arr_id
        tests:
          - unique
          - not_null
      - name: close_month
        description: Month in which ARR was active/ARR Movements occurred
        tests:
          - not_null
      - name: fiscal_year
        description: Fiscal year in which ARR was active/ARR Movements occurred
      - name: fiscal_quarter
        description: Fiscal quarter in which ARR was active/ARR Movements occurred
      - name: sales_channel
        description: Modified sales_motion from fct_cloud_subscription_transactions table
        tests:
          - not_null
      - name: is_first_day_of_fiscal_quarter
        description: >
          Indicates whether the date of the close_month value is the first day of a fiscal quarter
      - name: starting_arr
        description: >
          The amount of ARR from customers from this Sales Channel at the beginning this month. 
          Is equal to the ending_arr from customers from this Sales Channel for the previous month
      - name: ending_arr
        description: > 
          The amount of ARR from customers from this Sales Channel at the end of this month. 
          Is equal to the starting_arr from customers from this Sales Channel for the following month
      - name: ent_upgrade_mg_arr
        description: >
          The amount of Incremental ARR from customers moving from Self-Serve to Managed for this month
      - name: mg_starting_arr
        description: >
          For a customer that upgrades from Self-Serve to Managed, 
          the value of the Self-Serve contract when the Managed Deal closes 
          (i.e. the amount of Self-Serve ARR moving to Managed) for this month
      - name: mg_churn_arr
        description: The amount of Churned ARR from Managed customers who cancelled their account for this month
      - name: mg_downsell_arr
        description: >
          The amount of Contraction (aka Downgrade or Downsell) ARR from Managed customers for this month
      - name: mg_expansion_arr
        description: The amount of Expansion (aka Upgrade) ARR from Managed customers for this month
      - name: mg_land_arr
        description: >
          The amount of Land (aka New) ARR from Managed customers for this month
          Includes ARR from Net New dbt Cloud Customers and ARR from customers moving from Self-Serve to Managed
      - name: ss_land_arr
        description: >
          The amount of gross ARR from Net New Self-Serve dbt Customers for this month
      - name: ss_expand_arr
        description: >
          The amount of incremental ARR from existing Self-Serve customers expanding for this month
      - name: ss_reactivation_arr
        description: > 
          The amount of ARR from customers whose accounts are cancelled (Churn to MRR  = 0) 
          and then reactivated for this month
      - name: ss_downsell_arr
        description: >
          The amount of negative change in ARR from existing Self-Serve customers for this month
      - name: ss_churn_arr
        description: >
          The amount of ARR for Self-Serve customers who have churned to 0 in ARR or Cancelled their account for this month
      - name: ent_upgrade_ss_arr
        description: >
          For a customer that upgrades from Self-Serve to Managed, 
          this is the value of the Self-Serve contract when the Managed Deal closes 
          (i.e. the amount of Self-Serve ARR moving to Managed) for this month

  - name: fct_customer_activity_self_serve
    description: '{{ doc("fct_customer_activity_self_serve") }}'
    columns:
      - name: customer_activity_id
        tests:
          - unique
          - not_null
      - name: close_month
        description: Month in which ARR was active/ARR Movements occurred
        tests:
          - not_null
      - name: fiscal_year
        description: Fiscal year in which ARR was active/ARR Movements occurred
      - name: fiscal_quarter
        description: Fiscal quarter in which ARR was active/ARR Movements occurred
      - name: sales_channel
        description: Modified sales_motion from fct_cloud_subscription_transactions table
        tests:
          - not_null
      - name: customer_id
        description: Customer ID from fct_cloud_subscription_transactions table
        tests:
          - not_null
      - name: customer_name
        description: Customer Name from fct_cloud_subscription_transactions table
      - name: customer_activity_type
        description: Customer's activity categorization for the month. See description for more info
        tests:
          - not_null

  - name: fct_customer_activity_managed
    description: '{{ doc("fct_customer_activity_managed") }}'
    columns:
      - name: customer_activity_id
        tests:
          - unique
          - not_null
      - name: close_month
        description: >
          Month in which the close_date on the relevant opportunity record occurred
        tests:
          - not_null
      - name: fiscal_year
        description: >
          Fiscal year in which the close_date on the relevant opportunity record occurred
      - name: fiscal_quarter
        description: >
          Fiscal quarter in which the close_date on the relevant opportunity record occurred
      - name: sales_channel
        description: >
          The sales channel is 'Managed' for customers whose activity is derived 
          from the fct_opportunities model  
        tests:
          - not_null
      - name: customer_id
        description: Customer ID from the fct_opportunities model 
        tests:
          - not_null
      - name: customer_name
        description: Customer Name from the fct_opportunities model 
      - name: customer_activity_type
        description: Customer's activity categorization for the month. See description for more info
        tests:
          - not_null
      - name: expected_arr_delta
        description: >
          Amount of expected ARR change from opportunity record. Used downstream to calculate customer movement bucket

  - name: fct_customer_activity_managed_quarterly_types
    description: >
      '{{ doc("fct_customer_activity_managed") }}'
      '{{ doc("fct_customer_activity_managed_quarterly_types") }}'
    columns:
      - name: customer_quarterly_activity_id_sk
        tests:
          - unique
          - not_null
      - name: fiscal_quarter
        description: >
          Fiscal quarter in which the close_date on the relevant opportunity record occurred
        tests:
          - not_null
      - name: fiscal_year
        description: >
          Fiscal year in which the close_date on the relevant opportunity record occurred
      - name: sales_channel
        description: >
          The sales channel is 'Managed' for customers whose activity is derived 
          from the fct_opportunities model  
        tests:
          - not_null
      - name: customer_id
        description: Customer ID from the fct_opportunities model 
        tests:
          - not_null
      - name: customer_name
        description: Customer Name from the fct_opportunities model 
      - name: customer_activity_type
        description: Customer's activity categorization for the quarter. See description for more info
        tests:
          - not_null

  - name: fct_quarterly_enterprise_upgrade_customers
    description: >
      This model is at the quarter and customer grain. A customer included in this model has upgraded 
      from Self-Serve to a Managed plan within this quarter.
    columns:
      - name: quarterly_enterprise_upgrade_id_sk
        tests:
          - unique
          - not_null
      - name: fiscal_quarter
        description: >
          Fiscal quarter in which the Enterprise Upgrade ARR was recognized for the customer
        tests:
          - not_null
      - name: fiscal_year
        description: >
          Fiscal year in which the Enterprise Upgrade ARR was recognized for the customer
      - name: sales_channel
        description: >
          The sales channel is 'Managed' for customers who have upgraded to a Managed plan 
        tests:
          - not_null
      - name: customer_id
        description: Customer ID from the fct_arr_waterfall model
        tests:
          - not_null
      - name: customer_name
        description: Customer Name from fct_arr_waterfall model
      - name: customer_activity_type
        description: >
          Customer's activity movement categorization for the quarter. For customers who have upgraded 
          from Self-Serve to Managed within the quarter, this value will indicate an Enterprise Upgrade from Self-Serve. 
          See description for more info
        tests:
          - not_null
