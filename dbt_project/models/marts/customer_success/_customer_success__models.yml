version: 2

models:
  - name: fct_proserv_time_entries
    description: >
      One row in this model represents one instance of a Proserv
      member entering the time that they have spent working on various initiatives into Harvest.
    columns:
      - name: time_entry_id
        tests:
          - unique
          - not_null

  - name: fct_customer_onboarding_events
    description: This model calculates the time elapsed for each onboarding events that occur
      during a customer's onboarding process for _managed accounts_ (i.e. the
      date the deal was won -> when the customer reached the "Utilization" phase).
      The grain of this model is salesforce account ids.
    columns:
      - name: salesforce_account_id
        tests:
          - not_null
          - unique
      - name: closed_won_date
        tests:
          - not_null
      - name: days_to_kickoff_call_completed
        tests:
          - dbt_utils.accepted_range:
              min_value: 0
              config:
                severity: warn
      - name: days_to_rapid_onboarding_ended
        tests:
          - dbt_utils.accepted_range:
              min_value: 0
      - name: days_to_setup_ticket_closed
        tests:
          - dbt_utils.accepted_range:
              min_value: 0
      - name: days_to_utilization
        tests:
          - dbt_utils.accepted_range:
              min_value: 0

  - name: fct_customer_health
    description: This model is an an account-level table that aggregates account feature usage
      data and joins it to fields in salesforce data to provide a holistic view of a customers health.
    columns:
      - name: customer_id
        description: >
          A unique identifier for a dbt customer, as sourced and synthesized from vendor identifiers.
          See customer_id_type.
        tests:
          - not_null
          - unique
      - name: plan
        description: '{{ doc("cloud_plan") }}'
      - name: plan_tier
        description: '{{ doc("cloud_plan_tier") }}'
      - name: total_purchased_seats
        description: "The total _active_ purchased seats per customer. If a customer's license contract has not started yet, then this will be null."
      - name: total_assigned_seats
        description: "The total (non-deleted, non-internal) users for a given customer."
      - name: seat_utilization_pct
        description: "The total number of overall seats that are assigned out of the seats they purchased."
      - name: seat_utilization_pct_developer
        description: "The number of developer seats that are assigned out of the developer seats they purchased."
      - name: seat_utilization_pct_read_only
        description: "The number of read-only seats are that assigned out of the read-only seats they purchased."
      - name: cloud_maus
        description: "The total active cloud users for a given customer, across all of their paying Cloud Accounts, within the past 30 days."
      - name: cloud_maus_prev
        description: "The total active cloud users for a given customer, across all of their paying Cloud Accounts, within the past 31-60 days (think of this as the previous month)."
      - name: cloud_maus_pct_change
        description: "The pct change between the MAUs (i.e. users who went into Cloud wihtin the past 30 days vs previous 30-60 days -- think of this as the previous month)."
      - name: models_built_t30d
        description: "The total (successful) models built within the past trailing 30 days."
      - name: models_built_prev
        description: "The total (successful) models built from the previous 30-60 days (think of this as the previous month)."
      - name: models_built_pct_change
        description: "The pct change between the total models built in the trailing 30 days vs the trailing 30-60 days (i.e. MAUs vs Previous MAUs)."

      - name: t7d_ide_sessions_successful
        description: "Count of successful ide develop sessions in the 7 days previous to the current date."
      - name: t7d_ide_sessions_failed
        description: "Count of failed ide develop sessions in the 7 days previous to the current date."
      - name: t7d_ide_sessions
        description: "Total count of all ide develop sessions in the 7 days previous to the current date."
      - name: t7d_job_runs_successful
        description: "Count of successful job runs in the previous 7 days."
      - name: t7d_job_runs_failed
        description: "Count of failed job runs in the previous 7 days."
      - name: t7d_job_runs
        description: "Count of total job runs in the previous 7 days."
      - name: avg_csat
        description: "The average CSAT score for a given customer across all of their paying Cloud Accounts."
      - name: nps_score
        description: "The NPS score for a given customer across all of their paying Cloud Accounts."
      - name: champion_left_company_at
        description: >
          For a company as a whole, the most recent date that Champify identified that a Champion persona left.
          This is based on the oldest value between when Champify identified the Champion as leaving, or when
          Champify identified the Champion started a new job.
      - name: executive_influencer_left_company_at
        description: >
          For a company as a whole, the most recent date that Champify identified that an Executive Influencer persona left.
          This is based on the oldest value between when Champify identified the Executive Influencer as leaving, or when
          Champify identified the Executive Influencer started a new job.
      - name: hubspot_open_rate
        description: For a company as a whole, the number of opened emails divided by the number of delivered emails.

  - name: fct_cloud_accounts_feature_usage
    description: This model is an event table built of all the onboarding events that occur
      during a customer's onboarding process for _managed accounts_ (i.e. the
      date the deal was won -> when the customer reached the "Utilization" phase).
      The grain of this model is the event per managed customer (current and previous).
    columns:
      - name: id
        tests:
          - not_null
          - unique

  - name: fct_services_delivery
    description: >
      This model unions together historical PS engagement data from `int__historical_trello_sprints`
      and new data from Asana. It includes both Inbound and Enterprise professional services, as well
      as Rapid Onboardings and Group Trainings. One row represents one line-item unit for non-hours-based
      engagements. Aggregate hours are viewed as one line item unless broken out on the order form into
      multiple line items.
    columns:
      - name: unique_id
        tests:
          - unique
          - not_null
      - name: cost
        description: >
          The project cost the client will be charged. For internal projects, the usual cost is discounted
          15% as per the [PS Cross Charging Policy](https://www.notion.so/dbtlabs/Time-Tracking-for-the-Professional-Services-and-Training-Teams-c13926fc1d4048fa9e3070360241bb87#d93199819e9c4d2a99072920b9d9dcd1).
      - name: current_scheduling_section_name
        description: Current stage as described by organization on the Triage - Sold Services Board.
      - name: is_service_deferred
        description: True if any quanitity deferred on the opportunity line item in SFDC.
      - name: is_salesforce_opportunity_line_item_completed
        description: >
          Denotes if all projects associated with an opportunity_line_item
          are complete (i.e., all line-item quantities are consumed)
      - name: project_category
        description: >
          One of Professional Services, Training, or Internal Project
      - name: ps_monthly_hours
        description: >
          The 'Monthly Hours' attribute on an Asana task. This data may be manually curated depending on
          the type of service sold. NULL values may occur, but should be filled in by the Services Coordinator.
      - name: salesforce_opportunity_line_item_id
        description: The opportunity line item ID from Salesforce.
        tests:
          - relationships:
              to: ref('fct_opportunities_line_items')
              field: opportunity_line_item_id
              config:
                severity: warn
      - name: services_deferred_date
        description: The contract expiration date of the associated opportunity, when deferred services can be considered "delivered".
      - name: services_delivered_date
        description: The start of the week when service delivery was completed.
      - name: services_kicked_off_date
        description: The start of the week when service delivery began.

  - name: fct_services_pipeline
    description: >
      This model shows all services opp line items, including Professional Services
      products, Rapid Onboarding, and Group Training.
    columns:
      - name: unique_id
        tests:
          - unique
          - not_null

  - name: fct_services_goals
    description: >
      Professional Services and Training financial targets from Finance team.
    columns:
      - name: quarter_start
        tests:
          - unique
          - not_null

  - name: fct_rate_rapid_onboarding
    description: >
      One row in this model represents one rapid onboarding exit survey question in a survey response.
      Therefore the same company will show up multiple rows in a row.
    columns:
      - name: rate_rapid_onboarding__survey_question_response_id
        description: primary key of the fct_rate_rapid_onboarding
        tests:
          - unique
          - not_null
      - name: client_company_name
        tests:
          - not_null
      - name: account_id
        tests:
          - not_null
      - name: question_type
        tests:
          - not_null
      - name: question
        tests:
          - not_null

  - name: fct_certification_exam_deliveries
    description: One row in this model represents one certification exam delivery to a candidate.
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - candidate_email
            - completed_at
    columns:
      - name: credential_id
        description: >
          The credential id from Accredible. The join between Caveon and Accredible is done on email which is
          usually, but not always the same.
        tests:
          - unique
      - name: delivery_id
        description: Primary key for exam deliveries.
        tests:
          - unique
          - not_null

  - name: fct_certification_exam_items
    description: One row in this model represents one certification exam item response during a delivery.
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - exam_name
            - delivery_item_response_id
            - completed_at

  - name: rpt_customer_health_score
    description: >
      This table drives the logic to calculate the customer health score. It is dependant on [this Google Sheet](https://docs.google.com/spreadsheets/d/1R7aYq36PvlERx3CmBgQB6xXVgIOCIp7P6ZiiGtcOQIM/edit#gid=0)
      for the scores. More details around the health score can be found in [this Notion doc](https://www.notion.so/dbtlabs/Customer-Health-fa0a05ad1e834aa0a5e6eafee0741bed).
    columns:
      - name: customer_id
        tests:
          - unique
          - not_null

  - name: rpt_customer_health_score_history
    description: This table keeps a weekly history of the customer health score. It's a snapshot taken once per week of the full table so scores can be tracked over time.
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - customer_id
            - scored_at

  - name: fct_services_utilization_targets
    description: >
      Individual utilization targets for the Professional Services team.
    columns:
      - name: proserv_utilization_targets_id
        tests:
          - unique
          - not_null

  - name: fct_services_utilization_line_items
    description: >
      Calculated actual utilization for the Professional Services team. The grain
      includes the `salesforce_opportunity_line_item_id` to allow us to join to
      opportunity line items to determine delivery status.
    columns:
      - name: services_utilization_line_item_id
        tests:
          - unique
          - not_null

  - name: fct_services_utilization_summary
    description: >
      Calculated actual utilization for the Professional Services team. The grain
      is one row per person, per week.
    columns:
      - name: services_utilization_id
        tests:
          - unique
          - not_null

  - name: fct_proserv_team_technical_skills
    description: '{{ doc("technical_skills_ratings") }}'
    columns:
      - name: proserv_team_technical_skills_id
        tests:
          - unique
          - not_null
  
  - name: fct_complete_proserv_delighted_feedback
    description: >
      One row represents a single submission of the CSAT customer survey for
      ProServ (non-RO) engagements. It includes a numerical score as well as
      freeform typed responses to several questions.
    columns:
      - name: response_id
        tests:
          - unique
          - not_null

  - name: dim_certification_candidates
    description: >
      One row represents a candidate who has taken the certification exam
      one or more times.
    columns:
      - name: candidate_email
        description: Primary key
        tests:
          - unique
          - not_null

  - name: fct_proserv_engagement_csat
    description: >
      One row represents a ProServ engagement with all available
      CSAT scores (generated from employee and client survey
      responses). Includes engagements with recognized revenue only
      (ie at least partially complete).
    columns:
      - name: salesforce_opportunity_line_item_id
        description: primary key
        tests:
          - unique
          - not_null