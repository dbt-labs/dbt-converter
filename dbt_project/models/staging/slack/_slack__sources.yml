version: 2

sources:
  - name: slack
    database: raw
    loader: stitch_tap
    loaded_at_field: _sdc_batched_at
    description: "{{ doc('src_slack') }}"

    freshness:
      warn_after: {count: 24, period: hour}
      error_after: {count: 48, period: hour}

    meta:
      team: ['Marketing','Community']
      owner_name: Brandon Thomson

    tables:
      - name: access_logs
        description: Each access log entry represents a user accessing Slack from a specific user, IP address, and user agent combination. [Slack API Docs](https://api.slack.com/methods/team.accessLogs).
        tests:
          - dbt_utils.unique_combination_of_columns:
              combination_of_columns:
                - user_id
                - ip
                - user_agent

      - name: channels
        columns:
          - name: id
            tests:
              - unique
              - not_null

      - name: messages
        description: "{{ doc('src_slack__messages') }}"
        tests:
          - dbt_utils.unique_combination_of_columns:
              combination_of_columns:
                - ts
                - channel_id
        columns:
          - name: ts
            description: >
              Seconds since epoch. This timestamp is unique to a message within
              a channel.
            tests:
              - not_null
          - name: channel_id
            tests:
              - not_null
          - name: type
            tests:
              - accepted_values:
                  values: [message]
          - name: subtype
            description: Note that a NULL value means the message is a normal message.
            tests:
              - accepted_values:
                  values:
                    - bot_add
                    - bot_message
                    - bot_remove
                    - channel_archive
                    - channel_join
                    - channel_leave
                    - channel_name
                    - channel_purpose
                    - channel_topic
                    - channel_unarchive
                    - file_comment
                    - me_message
                    - pinned_item
                    - slackbot_response
                    - thread_broadcast
                    - tombstone
                  config:
                      store_failures: false
                  
          - name: replies
            description: >
              Array of replies. The first item in the array is the
              original message.
      - name: users
        columns:
          - name: id
            tests:
              - unique
              - not_null
          - name: is_invited_user
            description: >
              'True' when the user has been invited, but has not yet accepted
              their invite. Otherwise NULL.

              Note: this seems to differ from the definition in the [Slack API
              Docs](https://api.slack.com/types/user), however it has been manually
              validated against our workspace.
            tests:
              - accepted_values:
                  values:
                    - "True"

  - name: slack_historical
    database: raw
    description: "{{ doc('src_slack_historical') }}"
    
    loader: stitch
    loaded_at_field: _sdc_batched_at

    meta:
      team: ['Marketing','Community']
      owner_name: Brandon Thomson
    
    tables:
      - name: messages
        description: "{{ doc('src_slack_historical__messages') }}"
        tests:
          - dbt_utils.unique_combination_of_columns:
              combination_of_columns:
                - ts
                - channel
        columns:
          - name: ts
            description: Timestamps are unique within a channel
            tests:
              - not_null
          - name: channel
            tests:
              - not_null
          - name: type
            tests:
              - accepted_values:
                  values: [message]
          - name: subtype
            description: Note that a NULL value means the message is a normal message.
            tests:
            - accepted_values:
                values:
                  - bot_add
                  - bot_message
                  - channel_archive
                  - channel_join
                  - channel_leave
                  - channel_name
                  - channel_purpose
                  - channel_topic
                  - file_comment
                  - me_message
                  - pinned_item
                  - thread_broadcast
                  - tombstone
                config:
                    store_failures: false